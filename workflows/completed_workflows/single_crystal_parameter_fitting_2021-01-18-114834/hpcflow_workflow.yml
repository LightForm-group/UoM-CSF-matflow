# --- hpcflow profile generated by matflow (version: 0.2.13) on 2021.01.18 at 11:48:38 ---
# Note: modifications to this profile do NOT modify the matflow workflow submission.

parallel_modes:
  mpi:
    command: mpirun -np <<num_cores>>
  openmp:
    env:
      - export OMP_NUM_THREADS=<<num_cores>>
scheduler: sge
output_dir: output
error_dir: output
command_groups:
  - directory: .
    nesting: hold
    commands:
      - subshell: |-
          module purge
          module load tools/env/proxy
          module load mpi/intel-18.0/openmpi/4.0.1
          module load tools/gcc/cmake/3.13.2
          module load apps/binapps/anaconda3/2019.07
          export PETSC_DIR=/mnt/eps01-rds/jf01-home01/shared/petsc-3.12.2
          export PETSC_ARCH=mkl-opt
          export DAMASK_ROOT=/mnt/eps01-rds/jf01-home01/shared/DAMASK-master
          export HDF5_USE_FILE_LOCKING=FALSE
          export OMP_NUM_THREADS=1
          source $DAMASK_ROOT/env/DAMASK.sh
          PATH=$PETSC_DIR/$PETSC_ARCH/bin:$PATH
          LD_LIBRARY_PATH=$PETSC_DIR/$PETSC_ARCH/lib:$LD_LIBRARY_PATH
          source activate /mnt/eps01-rds/jf01-home01/shared/.conda/damask_env
          matflow prepare-task --task-idx=0 --iteration-idx=$ITER_IDX
    stats: false
    scheduler_options:
      P: jf01.prj
      l: short
    name: t1_pre
  - directory: <<task_1_generate_microstructure_seeds_dirs>>
    nesting: hold
    commands:
      - line: seeds_fromRandom -N <<matflow_input_num_grains>> -g <<matflow_input_grid_size>> >> positions_1.txt 2>> stderr.log
    scheduler_options:
      P: jf01.prj
      l: short
    name: t1
    stats: false
    stats_name: s1
    environment: |-
      module purge
      module load tools/env/proxy
      module load mpi/intel-18.0/openmpi/4.0.1
      module load tools/gcc/cmake/3.13.2
      module load apps/binapps/anaconda3/2019.07
      export PETSC_DIR=/mnt/eps01-rds/jf01-home01/shared/petsc-3.12.2
      export PETSC_ARCH=mkl-opt
      export DAMASK_ROOT=/mnt/eps01-rds/jf01-home01/shared/DAMASK-master
      export HDF5_USE_FILE_LOCKING=FALSE
      export OMP_NUM_THREADS=1
      source $DAMASK_ROOT/env/DAMASK.sh
      PATH=$PETSC_DIR/$PETSC_ARCH/bin:$PATH
      LD_LIBRARY_PATH=$PETSC_DIR/$PETSC_ARCH/lib:$LD_LIBRARY_PATH
      source activate /mnt/eps01-rds/jf01-home01/shared/.conda/damask_env
  - directory: .
    nesting: hold
    commands:
      - subshell: |-
          module purge
          module load tools/env/proxy
          module load mpi/intel-18.0/openmpi/4.0.1
          module load tools/gcc/cmake/3.13.2
          module load apps/binapps/anaconda3/2019.07
          export PETSC_DIR=/mnt/eps01-rds/jf01-home01/shared/petsc-3.12.2
          export PETSC_ARCH=mkl-opt
          export DAMASK_ROOT=/mnt/eps01-rds/jf01-home01/shared/DAMASK-master
          export HDF5_USE_FILE_LOCKING=FALSE
          export OMP_NUM_THREADS=1
          source $DAMASK_ROOT/env/DAMASK.sh
          PATH=$PETSC_DIR/$PETSC_ARCH/bin:$PATH
          LD_LIBRARY_PATH=$PETSC_DIR/$PETSC_ARCH/lib:$LD_LIBRARY_PATH
          source activate /mnt/eps01-rds/jf01-home01/shared/.conda/damask_env
          matflow process-task --task-idx=0 --iteration-idx=$ITER_IDX
      - subshell: |-
          module purge
          module load tools/env/proxy
          module load mpi/intel-18.0/openmpi/4.0.1
          module load tools/gcc/cmake/3.13.2
          module load apps/binapps/anaconda3/2019.07
          export PETSC_DIR=/mnt/eps01-rds/jf01-home01/shared/petsc-3.12.2
          export PETSC_ARCH=mkl-opt
          export DAMASK_ROOT=/mnt/eps01-rds/jf01-home01/shared/DAMASK-master
          export HDF5_USE_FILE_LOCKING=FALSE
          export OMP_NUM_THREADS=1
          source $DAMASK_ROOT/env/DAMASK.sh
          PATH=$PETSC_DIR/$PETSC_ARCH/bin:$PATH
          LD_LIBRARY_PATH=$PETSC_DIR/$PETSC_ARCH/lib:$LD_LIBRARY_PATH
          source activate /mnt/eps01-rds/jf01-home01/shared/.conda/damask_env
          matflow prepare-task --task-idx=1 --iteration-idx=$ITER_IDX
    stats: false
    scheduler_options:
      P: jf01.prj
      l: short
    name: t1+2_aux
  - directory: <<task_2_generate_volume_element_dirs>>
    nesting: hold
    commands:
      - line: matflow run-python-task --task-idx=1 --element-idx=$((($ITER_IDX * $SGE_TASK_LAST) + $SGE_TASK_ID - 1)) --directory=/net/scratch2/mbdxqap3/single_crystal_parameter_fitting_2021-01-18-114834
    scheduler_options:
      P: jf01.prj
      l: short
    name: t2
    stats: false
    stats_name: s2
    environment: |-
      module purge
      module load tools/env/proxy
      module load mpi/intel-18.0/openmpi/4.0.1
      module load tools/gcc/cmake/3.13.2
      module load apps/binapps/anaconda3/2019.07
      export PETSC_DIR=/mnt/eps01-rds/jf01-home01/shared/petsc-3.12.2
      export PETSC_ARCH=mkl-opt
      export DAMASK_ROOT=/mnt/eps01-rds/jf01-home01/shared/DAMASK-master
      export HDF5_USE_FILE_LOCKING=FALSE
      export OMP_NUM_THREADS=1
      source $DAMASK_ROOT/env/DAMASK.sh
      PATH=$PETSC_DIR/$PETSC_ARCH/bin:$PATH
      LD_LIBRARY_PATH=$PETSC_DIR/$PETSC_ARCH/lib:$LD_LIBRARY_PATH
      source activate /mnt/eps01-rds/jf01-home01/shared/.conda/damask_env
  - directory: .
    nesting: hold
    commands:
      - subshell: |-
          module purge
          module load tools/env/proxy
          module load mpi/intel-18.0/openmpi/4.0.1
          module load tools/gcc/cmake/3.13.2
          module load apps/binapps/anaconda3/2019.07
          export PETSC_DIR=/mnt/eps01-rds/jf01-home01/shared/petsc-3.12.2
          export PETSC_ARCH=mkl-opt
          export DAMASK_ROOT=/mnt/eps01-rds/jf01-home01/shared/DAMASK-master
          export HDF5_USE_FILE_LOCKING=FALSE
          export OMP_NUM_THREADS=1
          source $DAMASK_ROOT/env/DAMASK.sh
          PATH=$PETSC_DIR/$PETSC_ARCH/bin:$PATH
          LD_LIBRARY_PATH=$PETSC_DIR/$PETSC_ARCH/lib:$LD_LIBRARY_PATH
          source activate /mnt/eps01-rds/jf01-home01/shared/.conda/damask_env
          matflow process-task --task-idx=1 --iteration-idx=$ITER_IDX
      - subshell: |-
          export HDF5_USE_FILE_LOCKING=FALSE
          matflow prepare-task --task-idx=2 --iteration-idx=$ITER_IDX
    stats: false
    scheduler_options:
      P: jf01.prj
      l: short
    name: t2+3_aux
  - directory: /net/scratch2/mbdxqap3/single_crystal_parameter_fitting_2021-01-18-114834/task_3_generate_load_case/sources
    nesting: hold
    commands:
      - line: matflow prepare-sources --task-idx=2 --iteration-idx=$ITER_IDX
    environment: |-
      module load apps/binapps/anaconda3/2019.07
      source activate /mnt/eps01-rds/jf01-home01/shared/.conda/formable_env
      export HDF5_USE_FILE_LOCKING=FALSE
    stats: false
    scheduler_options:
      P: jf01.prj
      l: short
    name: t3_src
  - directory: <<task_3_generate_load_case_dirs>>
    nesting: hold
    commands:
      - line: python /net/scratch2/mbdxqap3/single_crystal_parameter_fitting_2021-01-18-114834/task_3_generate_load_case/sources/get_load_case_uniaxial.py inputs.hdf5
    scheduler_options:
      P: jf01.prj
      l: short
    name: t3
    stats: false
    stats_name: s3
    environment: |-
      module load apps/binapps/anaconda3/2019.07
      source activate /mnt/eps01-rds/jf01-home01/shared/.conda/formable_env
      export HDF5_USE_FILE_LOCKING=FALSE
  - directory: .
    nesting: hold
    commands:
      - subshell: |-
          export HDF5_USE_FILE_LOCKING=FALSE
          matflow process-task --task-idx=2 --iteration-idx=$ITER_IDX
      - subshell: |-
          export HDF5_USE_FILE_LOCKING=FALSE
          matflow prepare-task --task-idx=3 --iteration-idx=$ITER_IDX
    stats: false
    scheduler_options:
      P: jf01.prj
      l: short
    name: t3+4_aux
  - directory: /net/scratch2/mbdxqap3/single_crystal_parameter_fitting_2021-01-18-114834/task_4_get_tensile_test/sources
    nesting: hold
    commands:
      - line: matflow prepare-sources --task-idx=3 --iteration-idx=$ITER_IDX
    environment: |-
      module load apps/binapps/anaconda3/2019.07
      source activate /mnt/eps01-rds/jf01-home01/shared/.conda/formable_env
      export HDF5_USE_FILE_LOCKING=FALSE
    stats: false
    scheduler_options:
      P: jf01.prj
      l: short
    name: t4_src
  - directory: <<task_4_get_tensile_test_dirs>>
    nesting: hold
    commands:
      - line: python /net/scratch2/mbdxqap3/single_crystal_parameter_fitting_2021-01-18-114834/task_4_get_tensile_test/sources/get_tensile_test.py inputs.hdf5
    scheduler_options:
      P: jf01.prj
      l: short
    name: t4
    stats: false
    stats_name: s4
    environment: |-
      module load apps/binapps/anaconda3/2019.07
      source activate /mnt/eps01-rds/jf01-home01/shared/.conda/formable_env
      export HDF5_USE_FILE_LOCKING=FALSE
  - directory: .
    nesting: hold
    commands:
      - subshell: |-
          export HDF5_USE_FILE_LOCKING=FALSE
          matflow process-task --task-idx=3 --iteration-idx=$ITER_IDX
      - subshell: |-
          module purge
          module load tools/env/proxy
          module load mpi/intel-18.0/openmpi/4.0.1
          module load tools/gcc/cmake/3.13.2
          module load apps/binapps/anaconda3/2019.07
          export PETSC_DIR=/mnt/eps01-rds/jf01-home01/shared/petsc-3.12.2
          export PETSC_ARCH=mkl-opt
          export DAMASK_ROOT=/mnt/eps01-rds/jf01-home01/shared/DAMASK-master
          export HDF5_USE_FILE_LOCKING=FALSE
          export OMP_NUM_THREADS=1
          source $DAMASK_ROOT/env/DAMASK.sh
          PATH=$PETSC_DIR/$PETSC_ARCH/bin:$PATH
          LD_LIBRARY_PATH=$PETSC_DIR/$PETSC_ARCH/lib:$LD_LIBRARY_PATH
          source activate /mnt/eps01-rds/jf01-home01/shared/.conda/damask_env
          matflow prepare-task --task-idx=4 --iteration-idx=$ITER_IDX
    stats: false
    scheduler_options:
      P: jf01.prj
      l: short
    name: t4+5_aux
  - directory: <<task_5_simulate_volume_element_loading_dirs>>
    nesting: hold
    commands:
      - line: DAMASK_grid --load load.load --geom geom.geom >> stdout.log 2>> stderr.log
        parallel_mode: MPI
    scheduler_options:
      pe: smp.pe 16
      P: jf01.prj
    name: t5
    stats: false
    stats_name: s5
    environment: |-
      module purge
      module load tools/env/proxy
      module load mpi/intel-18.0/openmpi/4.0.1
      module load tools/gcc/cmake/3.13.2
      module load apps/binapps/anaconda3/2019.07
      export PETSC_DIR=/mnt/eps01-rds/jf01-home01/shared/petsc-3.12.2
      export PETSC_ARCH=mkl-opt
      export DAMASK_ROOT=/mnt/eps01-rds/jf01-home01/shared/DAMASK-master
      export HDF5_USE_FILE_LOCKING=FALSE
      export OMP_NUM_THREADS=1
      source $DAMASK_ROOT/env/DAMASK.sh
      PATH=$PETSC_DIR/$PETSC_ARCH/bin:$PATH
      LD_LIBRARY_PATH=$PETSC_DIR/$PETSC_ARCH/lib:$LD_LIBRARY_PATH
      source activate /mnt/eps01-rds/jf01-home01/shared/.conda/damask_env
  - directory: <<task_5_simulate_volume_element_loading_dirs>>
    nesting:
    commands:
      - subshell: |-
          module purge
          module load tools/env/proxy
          module load mpi/intel-18.0/openmpi/4.0.1
          module load tools/gcc/cmake/3.13.2
          module load apps/binapps/anaconda3/2019.07
          export PETSC_DIR=/mnt/eps01-rds/jf01-home01/shared/petsc-3.12.2
          export PETSC_ARCH=mkl-opt
          export DAMASK_ROOT=/mnt/eps01-rds/jf01-home01/shared/DAMASK-master
          export HDF5_USE_FILE_LOCKING=FALSE
          export OMP_NUM_THREADS=1
          source $DAMASK_ROOT/env/DAMASK.sh
          PATH=$PETSC_DIR/$PETSC_ARCH/bin:$PATH
          LD_LIBRARY_PATH=$PETSC_DIR/$PETSC_ARCH/lib:$LD_LIBRARY_PATH
          source activate /mnt/eps01-rds/jf01-home01/shared/.conda/damask_env
          matflow process-task-element --task-idx=4 --element-idx=$((($ITER_IDX * $SGE_TASK_LAST) + $SGE_TASK_ID - 1)) --directory=/net/scratch2/mbdxqap3/single_crystal_parameter_fitting_2021-01-18-114834 --array
    stats: false
    scheduler_options: &id001
      pe: smp.pe 4
      P: jf01.prj
    name: t5_pro
  - directory: .
    nesting: hold
    commands:
      - subshell: |-
          module purge
          module load tools/env/proxy
          module load mpi/intel-18.0/openmpi/4.0.1
          module load tools/gcc/cmake/3.13.2
          module load apps/binapps/anaconda3/2019.07
          export PETSC_DIR=/mnt/eps01-rds/jf01-home01/shared/petsc-3.12.2
          export PETSC_ARCH=mkl-opt
          export DAMASK_ROOT=/mnt/eps01-rds/jf01-home01/shared/DAMASK-master
          export HDF5_USE_FILE_LOCKING=FALSE
          export OMP_NUM_THREADS=1
          source $DAMASK_ROOT/env/DAMASK.sh
          PATH=$PETSC_DIR/$PETSC_ARCH/bin:$PATH
          LD_LIBRARY_PATH=$PETSC_DIR/$PETSC_ARCH/lib:$LD_LIBRARY_PATH
          source activate /mnt/eps01-rds/jf01-home01/shared/.conda/damask_env
          matflow process-task --task-idx=4 --iteration-idx=$ITER_IDX --array
    stats: false
    scheduler_options: *id001
    name: t5_pro
  - directory: .
    nesting: hold
    commands:
      - subshell: |-
          export HDF5_USE_FILE_LOCKING=FALSE
          matflow prepare-task --task-idx=5 --iteration-idx=$ITER_IDX
    stats: false
    scheduler_options:
      P: jf01.prj
      l: short
    name: t6_pre
  - directory: /net/scratch2/mbdxqap3/single_crystal_parameter_fitting_2021-01-18-114834/task_6_optimise_single_crystal_parameters/sources
    nesting: hold
    commands:
      - line: matflow prepare-sources --task-idx=5 --iteration-idx=$ITER_IDX
    environment: |-
      module load apps/binapps/anaconda3/2019.07
      source activate /mnt/eps01-rds/jf01-home01/shared/.conda/formable_env
      export HDF5_USE_FILE_LOCKING=FALSE
    stats: false
    scheduler_options:
      P: jf01.prj
      l: short
    name: t6_src
  - directory: <<task_6_optimise_single_crystal_parameters_dirs>>
    nesting: hold
    commands:
      - line: python /net/scratch2/mbdxqap3/single_crystal_parameter_fitting_2021-01-18-114834/task_6_optimise_single_crystal_parameters/sources/optimise_SC_parameters_LM.py inputs.hdf5
    scheduler_options:
      P: jf01.prj
      l: short
    name: t6
    stats: false
    stats_name: s6
    environment: |-
      module load apps/binapps/anaconda3/2019.07
      source activate /mnt/eps01-rds/jf01-home01/shared/.conda/formable_env
      export HDF5_USE_FILE_LOCKING=FALSE
  - directory: .
    nesting: hold
    commands:
      - subshell: |-
          export HDF5_USE_FILE_LOCKING=FALSE
          matflow process-task --task-idx=5 --iteration-idx=$ITER_IDX
    stats: false
    scheduler_options:
      P: jf01.prj
      l: short
    name: t6_pro
    archive: dropbox
    archive_excludes:
      - '*.spectralOut'
      - geom_load.hdf5
  - directory: .
    nesting: hold
    commands: |-
      matflow write-element-directories --iteration-idx=$(($ITER_IDX+1))
    stats: false
    scheduler_options:
      P: jf01.prj
      l: short
    name: iterate
variables:
  matflow_input_num_grains:
    file_contents:
      path: matflow_input_num_grains.txt
      expected_multiplicity: 1
    value: '{}'
  matflow_input_grid_size:
    file_contents:
      path: matflow_input_grid_size.txt
      expected_multiplicity: 1
    value: '{}'
  task_1_generate_microstructure_seeds_dirs:
    file_regex:
      pattern: (task_1_generate_microstructure_seeds)$
      is_dir: true
      group: 0
    value: '{}'
  task_2_generate_volume_element_dirs:
    file_regex:
      pattern: (task_2_generate_volume_element)$
      is_dir: true
      group: 0
    value: '{}'
  task_3_generate_load_case_dirs:
    file_regex:
      pattern: (task_3_generate_load_case)$
      is_dir: true
      group: 0
    value: '{}'
  task_4_get_tensile_test_dirs:
    file_regex:
      pattern: (task_4_get_tensile_test)$
      is_dir: true
      group: 0
    value: '{}'
  task_5_simulate_volume_element_loading_dirs:
    file_regex:
      pattern: (task_5_simulate_volume_element_loading/element_[0-9]+$)$
      is_dir: true
      group: 0
    value: '{}'
  task_6_optimise_single_crystal_parameters_dirs:
    file_regex:
      pattern: (task_6_optimise_single_crystal_parameters/element_[0-9]+$)$
      is_dir: true
      group: 0
    value: '{}'
loop:
  max_iterations: 4
  groups:
    - 10
    - 11
    - 12
    - 13
    - 14
    - 15
    - 16
    - 17
    - 18
archive_locations:
  dropbox:
    cloud_provider: dropbox
    path: /sims_db/matflow/archived
    root_directory_name: parent
